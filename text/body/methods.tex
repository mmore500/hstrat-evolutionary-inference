\section{Methods}
\label{sec:methods}

\subsection{Model System}

Experiments testing the relationships between evolutionary dynamics, reconstruction error, and phylogenetic structure required a model system amenable to direct, interpretable tuning of ecology, spatial structure, and selection pressure.
Additionally, in order to make findings relevant to large-scale phylogenetic analyses, computational efficiency was necessary to facilitate large population size and high generation counts.
Finally, a parsimonious and generic model system was desired so that findings would better generalize across digital evolution systems.

A parsimonious model system was devised to fulfill these objectives.
Genomes in this system comprised a single floating-point value, with higher magnitude corresponding to higher fitness.
Population size 32,768 ($2^{15}$) was used for all experiments.
Selection was performed using tournament selection with synchronous generations.
Treatments' selection pressure was controlled via tournament size.
Mutation was applied after selection, with a value drawn from a unit Gaussian distribution added to all genomes.
Evolutionary runs were ended after 262,144 ($2^{18}$) generations.
Each run required around 4 hours of compute time.

Treatments incorporating spatial structure used a simple island model.
In spatially structured treatments, individuals were evenly divided among 1,024 islands and only competed in selection tournaments against sympatric population members.
Islands were arranged in a one-dimensional closed ring and 1\% of population members migrated to a neighboring island each generation.

Treatments incorporating ecology used a simple niche model.
Population slots were split evenly between niches.
Organisms were arbitrarily assigned to a niche at genesis and were only allowed to occupy population slots assigned to that niche.
Therefore, individuals exclusively participated in selection tournaments with members of their own niche.
In treatments also incorporating spatial structure, an even allotment of population slots was provided for every niche on every island.
Every generation, individuals swapped niches with probability $3.0517578125 \times 10^{-8}$ (chosen so one niche swap would be expected every 1,000 generations).

For our main experiments, we defined the following ``regimes'' of evolutionary conditions:
\begin{itemize}
  \item \textit{plain}: tournament size 2 with no niching and no islands,
  \item \textit{weak selection}: tournament size 1 with no niching and no islands,
  \item \textit{strong selection}: tournament size 4 with no niching and no islands,
  \item \textit{spatial structure}: tournament size 2 with no niching and 1,024 islands,
  \item \textit{weak 4 niche ecology}: tournament size 2 with 4 niches and niche swap probability increased 100$\times$,
  \item \textit{4 niche ecology}: tournament size 2 with 4 niches, and
  \item \textit{8 niche ecology}: tournament size 8 with 4 niches.
\end{itemize}

In follow-up experiments testing ecological dynamics with a spatial background, we defined the following additional evolutionary ``regimes:''
\begin{itemize}
  \item \textit{plain}: tournament size 2 with no niching over 1,024 islands,
  \item \textit{weak 4 niche ecology}: tournament size 2 with 4 niches and niche swap probability increased 100$\times$ over 1,024 islands,
  \item \textit{4 niche ecology}: tournament size 2 with 4 niches over 1,024 islands, and
  \item \textit{8 niche ecology}: tournament size 8 with 4 niches over 1,024 islands.
\end{itemize}

Finally, to foster generalizability of findings, all experiments were performed with two alternate ``sensitivity'' variables: evolutionary length in generations and mutation operator.
Shorter runs of 32,768 and 98,304 generations were tested in addition to the full-length runs.
We refer to full-length runs as completing ``epoch 7'' and the shorter runs as completing ``epoch 0'' and ``epoch 2'' respectively.
One additional mutation operator was tested to contrast the unit Gaussian distribution: the unit exponential distribution.
Under this distribution, deleterious mutations are not possible and large-effect mutations are more likely.

Across all experiments, each treatment comprised 50 replicates.

\subsection{Avida}

TODO \citep{ofria2004avida}

% AVIDA NO ECOLOGY
% RESOURCE  resECHO:inflow=400:outflow=0.01

% REACTION  ECHO echo  process:resource=resECHO:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION  NOT  not   process:resource=resECHO:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION  NAND nand  process:resource=resECHO:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION  AND  and   process:resource=resECHO:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2


% AVIDA RICH ECOLOGY
% RESOURCE  resECHO:inflow=100:outflow=0.01
% RESOURCE  resNOT:inflow=100:outflow=0.01
% RESOURCE resNAND:inflow=100:outflow=0.01
% RESOURCE  resAND:inflow=100:outflow=0.01
% RESOURCE resORN:inflow=100:outflow=0.01
% RESOURCE  resOR:inflow=100:outflow=0.01
% RESOURCE  resANDN:inflow=100:outflow=0.01
% RESOURCE  resNOR:inflow=100:outflow=0.01
% RESOURCE  resXOR:inflow=100:outflow=0.01
% RESOURCE  resEQU:inflow=100:outflow=0.01
% RESOURCE resLOG3BO:inflow=100:outflow=0.01
% RESOURCE resLOG3CI:inflow=100:outflow=0.01
% RESOURCE resLOG3BZ:inflow=100:outflow=0.01
% RESOURCE resLOG3AG:inflow=100:outflow=0.01
% RESOURCE resLOG3CP:inflow=100:outflow=0.01
% RESOURCE resLOG3BY:inflow=100:outflow=0.01
% RESOURCE resLOG3BS:inflow=100:outflow=0.01
% RESOURCE resLOG3BA:inflow=100:outflow=0.01
% RESOURCE resLOG3CJ:inflow=100:outflow=0.01
% RESOURCE resLOG3AH:inflow=100:outflow=0.01
% RESOURCE resLOG3AQ:inflow=100:outflow=0.01
% RESOURCE resLOG3CN:inflow=100:outflow=0.01
% RESOURCE resLOG3CB:inflow=100:outflow=0.01
% RESOURCE resLOG3AX:inflow=100:outflow=0.01
% RESOURCE resLOG3AR:inflow=100:outflow=0.01
% RESOURCE resLOG3AO:inflow=100:outflow=0.01
% RESOURCE resLOG3CH:inflow=100:outflow=0.01
% RESOURCE resLOG3CC:inflow=100:outflow=0.01

% REACTION  ECHO echo  process:resource=resECHO:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION  NOT  not   process:resource=resNOT:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION  NAND nand  process:resource=resNAND:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION  AND  and   process:resource=resAND:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION  ORN  orn   process:resource=resORN:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION  OR   or    process:resource=resOR:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION  ANDN andn  process:resource=resANDN:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION  NOR nor  process:resource=resANDN:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION  XOR xor  process:resource=resANDN:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION  EQU equ  process:resource=resANDN:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION LOG3BO logic_3BO process:resource=resLOG3BO:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION LOG3CI logic_3CI process:resource=resLOG3CI:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION LOG3BZ logic_3BZ process:resource=resLOG3BZ:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION LOG3AG logic_3AG process:resource=resLOG3AG:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION LOG3CP logic_3CP process:resource=resLOG3CP:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION LOG3BY logic_3BY process:resource=resLOG3BY:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION LOG3BS logic_3BS process:resource=resLOG3BS:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION LOG3BA logic_3BA process:resource=resLOG3BA:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION LOG3CJ logic_3CJ process:resource=resLOG3CJ:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION LOG3AH logic_3AH process:resource=resLOG3AH:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION LOG3AQ logic_3AQ process:resource=resLOG3AQ:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION LOG3CN logic_3CN process:resource=resLOG3CN:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION LOG3CB logic_3CB process:resource=resLOG3CB:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION LOG3AX logic_3AX process:resource=resLOG3AX:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION LOG3AR logic_3AR process:resource=resLOG3AR:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION LOG3AO logic_3AO process:resource=resLOG3AO:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION LOG3CH logic_3CH process:resource=resLOG3CH:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION LOG3CC logic_3CC process:resource=resLOG3CC:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2

% AVIDA ECOLOGY
% RESOURCE  resECHO:inflow=100:outflow=0.01
% RESOURCE  resNOT:inflow=100:outflow=0.01
% RESOURCE resNAND:inflow=100:outflow=0.01
% RESOURCE  resAND:inflow=100:outflow=0.01

% REACTION  ECHO echo  process:resource=resECHO:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION  NOT  not   process:resource=resNOT:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION  NAND nand  process:resource=resNAND:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION  AND  and   process:resource=resAND:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2

% AVIDA WEAK ECOLOGY
% RESOURCE  resECHO:inflow=300:outflow=0.01
% RESOURCE  resNOT:inflow=33:outflow=0.01
% RESOURCE resNAND:inflow=33:outflow=0.01
% RESOURCE  resAND:inflow=33:outflow=0.01


% REACTION  ECHO echo  process:resource=resECHO:value=1.0:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION  NOT  not   process:resource=resNOT:value=0.2:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION  NAND nand  process:resource=resNAND:value=0.2:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2
% REACTION  AND  and   process:resource=resAND:value=0.2:frac=0.0025:type=pow:max=10.0 requisite:max_tot_count=2


% PLAIN
% WORLD_GEOMETRY 3
% DEATH_PROB_PARENT 0.2

% SELECTION STRONG
% WORLD_GEOMETRY 3
% DEATH_METHOD 0
% ALLOW_PARENT 0

% SPATIAL

% WORLD_GEOMETRY 2
% DEATH_PROB_PARENT 0.2

\subsection{Gen3sis}

TODO \citep{hagen2021gen3sis}

ECOLOGY \url{https://cran.r-project.org/web/packages/gen3sis/vignettes/create_config.html}

SPATIAL STRUCTURE
water ignored vs water as barrier

Synthesized from a number of sources \citep{straume2020global,westerhold2020astronomically,fick2017worldclim,hagen2019mountain,annan2013new,cramwinckel2018synchronous,evans2018eocene,hollis2019deepmip,hutchinson2018climate,keating2011warm,sijp2014role,zhang2019evolution}.


\subsection{Hereditary Stratigraphic Annotations and Tree Reconstruction}

Experiments testing the impact of phylogenetic inference error on phylometrics employ the recently-developed ``hereditary stratigraphy'' technique to facilitate phylogenetic inference \citep{moreno2022hstrat}.
This technique works by attaching heritable annotations to individual digital genomes.
Every generation, a new random ``fingerprint'' is generated and appended to the individuals' inherited annotations.
To reconstruct phylogenetic history, fingerprints from extant organisms' annotations can be compared.
Where two organisms share identical fingerprints along the record, they likely shared common ancestry.
Mismatching fingerprints indicate a split in compared organisms' ancestry.

Hereditary stratigraphy enables a tunable trade-off between annotation size and estimation accuracy.
Fingerprints may be discarded to decrease annotation size at the cost of reduced density of reference points to test for common (or divergent) ancestry along organisms' generational histories.

We test four levels of fingerprint retention.
Each level is described as a $p\%$ ``resolution'' meaning that the generational distance between reference points any number of generations $k$ back is less than $(p / 100) \times k$.
So, a high percentage $p$ indicates coarse resolution and a low percentage $p$ indicates fine resolution.
In detail, at the conclusion of 262,144 generation evolutionary runs,
\begin{itemize}
  \item at 33\% resolution 68 fingerprints are retained per genome,
  \item at 10\% resolution 170 fingerprints are retained per genome,
  \item at 3\% resolution 435 fingerprints are retained per genome, and
  \item at 1\% resolution 1,239 fingerprints are retained per genome.
\end{itemize}

This work uses 1 byte fingerprints, which collide with probability $1/256$.
Greater space efficiency could be achieved using 1 bit fingerprints.
However, this would require careful accounting for ubiquitous generation of identical fingerprints by chance and is left to future work.

Previous work with hereditary stratigraphy used UPGMA distance-based reconstruction techniques \citep{moreno2022hereditary}.
Large-scale reconstructions required for these experiments necessitated development of a more efficient technique that did not require all pairs (i.e., $O(n^2)$ distance comparison.
To accomplish this, we devised an agglomerative tree building algorithm that works by successively adding leaf organism annotations and percolating them down from the tree root along the tree path of internal nodes consistent with their fingerprint sequence, then affixing them where common ancestry ends.
This new tree-building approach reduced compute time from multiple hours to around 5 minutes in most cases.
Supplementary Listing \ref{lst:build_tree_trie} provides source code with full implementation details, see \citep{moreno2024analysis} for a more detailed discussion.

\input{fig/plain-perfect-and-reconstruction-phylogenies}

To assess the efficacy of the new agglomerative tree-building approach, we calculated all reconstructed trees' quartet distance to their respective reference.
Quartet distance ranges from 0 (between identical trees) to 0.75 (between random trees), providing in this case a measure of reconstruction error.
As expected, this measure of reconstruction error varied significantly with resolution for trees across all evolutionary regimes (Kruskal-Wallis tests; all $p < 10^{-20}$; Supplementary Table \ref{tab:reconstruction-error-comparisons-between-resolutions}).
Reconstruction error also varied significantly with evolutionary regime for each reconstruction resolution level (Kruskal-Wallis tests; all $p < 10^{-8}$; Supplementary Table \ref{tab:reconstruction-error-comparisons-between-regimes}).

For 3\% and 1\% resolutions, mean reconstruction error was less than 0.01 in all cases and at 10\% resolution mean reconstruction error was less than 0.05 in all cases.
At 33\% resolution, mean reconstruction error was less than 0.12 in all cases.
The largest reconstruction errors observed at 1\%, 3\%, 10\%, and 33\% resolutions were, respectively, 0.051 (weak selection regime), 0.093 (weak 4 niche ecology regime), 0.14 (plain evolutionary regime), and 0.45 (plain evolutionary regime).
Supplementary Table \ref{tab:tree-reconstruction-quality-quartet-summary-statistics} reports mean, median, standard deviation, and maxima for reconstruction error across surveyed evolutionary conditions.

To generate reconstructed trees in experiments, we simulated the inheritance of hereditary stratigraphic annotations along a reference phylogeny to yield the set of annotations that would be attached to extant population members at the end of a run, then used our agglomerative tree building technique to infer.
Thus, each reconstruction replicate has a directly-corresponding reference tree from a perfect-tree treatment replicate.
Figure \ref{fig:plain-perfect-and-reconstruction-phylogenies} shows a reference tree and corresponding reconstructions performed using 1\%, 3\%, 10\%, and 33\% resolution hereditary stratigraph annotations.

\subsection{Phylometrics}

A wide range of metrics exists for quantifying the topology of a phylogeny.
Tucker et.
al showed that these metrics can be classified into the following three dimensions: richness, divergence, and regularity \citep{tuckerGuidePhylogeneticMetrics2017}.
Richness metrics quantify the amount of phylogenetic diversity/evolutionary history represented by a phylogeny.
Divergence metrics quantify how different the units of the phylogeny are from each other.
Regularity metrics quantify the variance of other properties (i.e. how consistent they are across the phylogeny).
Here, we focus on four metrics spread across these categories:

\textbf{Sum Distance:} TODO
This measurement simply counts the number of non-extant taxa in the phylogeny (i.e. the number of non-leaf nodes).
Because the reconstructed trees do not contain any internal nodes not associated with a branching point (i.e. unifurcations), we strip such nodes out of the reference trees as well.
It is a metric of phylogenetic richness and is closely related to Faith's classic phylogenetic diversity metric \citep{faithConservationEvaluationPhylogenetic1992}, the primary differences being that the number of internal nodes is unaffected by branch lengths and the number of leaf nodes.
Consequently, we would expect it to be increased by the presence of ecology or spatial structure, as both these factors increase diversity.

\textbf{Colless-like Index:}
The original Colless Index \citep{collessReviewPhylogeneticsTheory1982}, also often referred to as $I_c$ \citep{shaoTreeBalance1990}, is a measure of tree imbalance (i.e. it gets higher as the tree gets less balanced).
In the context of Tucker et.
al's framework, it is a regularity metric.
However, the traditional Colless Index only works for strictly bifurcating trees.
As our trees have multifurcations, we instead use the Colless-like Index, which is an extension of the Colless Index to multifurcating trees \citep{mirSoundCollesslikeBalance2018}.
Tree imbalance is thought to be associated with varying ecological pressures \citep{chamberlainPhylogeneticTreeShape2014, burressEcologicalOpportunityAlters} and has also been observed to increase in the presence of spatial structure \citep{scottInferringTumorProliferative2020}.

\textbf{Mean Pairwise Distance:}
This metric is calculated by computing the shortest distance between all pairs of leaf nodes and taking the mean of these values \citep{webbExploringPhylogeneticStructure2000}.
Note that these distances are measured in terms of the number of nodes in between the pair, not in terms of branch lengths.
Mean pairwise distance is a metric of evolutionary divergence \citep{tuckerGuidePhylogeneticMetrics2017}.
Mean pairwise distance should be increased by scenarios that promote the long-term maintenance of distinct phylogenetic branches, such as ecology.
Conversely, factors that act to reduce diversity should also reduce mean pairwise distance.

\textbf{Mean Evolutionary Distinctiveness:}
Evolutionary distinctiveness is a metric that can be calculated for individual taxa to quantify how evolutionarily different that taxon is from all other taxa in the phylogeny \citep{isaacMammalsEDGEConservation2007}.
To get mean evolutionary distinctiveness, we average this value across all extant taxa in the tree.
Like mean pairwise distance, mean evolutionary distinctiveness is a metric of evolutionary divergence.
However, it is known to capture substantially different information than mean pairwise distance \citep{tuckerGuidePhylogeneticMetrics2017}.
Unlike our other metrics, evolutionary distinctiveness is heavily influenced by branch length.
We generally expect mean evolutionary distinctiveness to be increased by similar factors to mean pairwise distance.

\subsection{Effect-size Analysis}

TODO describe Cliff's delta
\citep{meissel2024using,cliff1993dominance}

Note that we report negative values, which align with positive is larger intuition.

TODO \citep{mann1947on}

\subsection{Software and Data Availability}

Software, configuration files, and executable notebooks for this work are available at \url{https://github.com/mmore500/hstrat-evolutionary-inference}.
Data and supplemental materials are available via the Open Science Framework \url{https://osf.io/vtxwd/} \citep{foster2017open}.
Note that materials for earlier versions of this work are also contained in these repositories \citep{moreno2023toward}.

All hereditary stratigraph annotation, reference phylogeny generation, and phylogenetic reconstruction tools used in this work are published in the \texttt{hstrat} Python package \citep{moreno2022hstrat}.
This project can be visited at \url{https://github.com/mmore500/hstrat}.

This project uses data formats and tools associated with the ALife Data Standards project \citep{lalejini2019data} and benefited from many pieces of open-source scientific software \citep{ofria2020empirical,sand2014tqdist,2020SciPy-NMeth,harris2020array,reback2020pandas,mckinney-proc-scipy-2010,sukumaran2010dendropy,cock2009biopython,torchiano2016effsize,waskom2021seaborn,hunter2007matplotlib,moreno2024apc,moreno2024qspool,moreno2023teeplot,hagen2021gen3sis,ofria2004avida,torchiano2016effsize}.

TODO: cite phylotrackpy?
